<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../stylesheets/style.css">
    <link rel="stylesheet" type="text/css" href="../stylesheets/tabs.css">
    <link rel="stylesheet" type="text/css" href="../stylesheets/map.css">

    <!--Firebase Libraries and Init with config-->
    <script src="https://www.gstatic.com/firebasejs/4.7.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.7.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase-firestore.js"></script>

    <script type="text/javascript" src="../javascripts/FirebaseInitialisation.js"></script>
    <script type="text/javascript" src="../javascripts/Firebase.js"></script>
    <script type="text/javascript" src="../javascripts/Client.js"></script>
    <script type="text/javascript" src="../javascripts/Mine.js"></script>
    <script type="text/javascript" src="../javascripts/Block.js"></script>
    <script type="text/javascript" src="../javascripts/Message.js"></script>



    <script>
        var users = [];
        var allBlocks = [];
        var networkDiff = 6618932150;
        var messages = [];
        // a = Hash(0xf6c94957, 0x27359d02, 3).toString(16);
        var chainLength = 0;
        var localUser = new User();
        localUser.userID = "U0";
        localUser.name = "Local User";
    </script>

    <title>Blockchain</title>

</head>
<body>

<!--Logo Elements-->
<div class="logo-container" >
    <img id="logo-tall" src="https://i.imgur.com/sb4fvdm.png"/>
    <img id="logo-wide" src="https://i.imgur.com/vxaU676.png"/>
</div>
<!--Client map-->
<ul id="map"></ul>


<div class="message tabbox">
    <!--Tab Headers-->
    <input class="tabs" id="tab1" type="radio" name="tabs" checked>
    <label class="tab" for="tab1">Messages</label>

    <input class="tabs" id="tab2" type="radio" name="tabs">
    <label class="tab" for="tab2">Blocks</label>

    <input class="tabs" id="tab3" type="radio" name="tabs">
    <label class="tab" for="tab3">Clients</label>

    <input class="tabs" id="tab4" type="radio" name="tabs">
    <label class="tab" for="tab4">Mining</label>

    <!--Message Tab-->
    <section id="content1">
        <div class = "tab_contents">
            <div class="tab_header">
                <div class="header_box">
                    <input class="m_input" id="messageText" type="text" name="fname" placeholder="Write Message Here.." value="">
                    <button class="m_send" id="btn_NewMessage" onclick="newMessage()">Send</button>
                </div>
            </div>

            <ul id="tabs_message_list" class="tab_items_list">
                <!--<div id="m1" class="item_portion">-->
                    <!--<div class = "m_leftsection">-->
                        <!--<div class = "m_leftsectionupper">-->
                            <!--<div class = "m_user">John</div>-->
                            <!--<div class = "m_timesection">-->
                                <!--<div class = "m_timetitle">Time: </div>-->
                                <!--<div class = "m_time">12:58</div>-->
                            <!--</div>-->
                        <!--</div>-->
                        <!--<div class="m_progresssection">-->
                            <!--<div class="m_progressbar">-->
                                <!--<div class="m_progress"></div>-->
                            <!--</div>-->
                        <!--</div>-->
                    <!--</div>-->
                    <!--<div class = "m_content">-->
                        <!--Hello There!!-->
                    <!--</div>-->
                    <!--<div class = "m_cblock"></div>-->
                <!--</div>-->
            </ul>

        </div>
    </section>

    <!--Blocks Tab-->
    <section id="content2">
        <div class = "tab_contents">


            <div class="tab_header">
                <div class="header_box">
                    <div class="title" id="b_difficulty">Difficulty: 45</div>
                    <div class="single_chunk" id="b_chainlength">Chain Length: 45</div>
                </div>
            </div>

<ul id="tabs_block_list" class = "tab_items_list">

</ul>
            <!--<div id="b1" class="item_portion">-->
                <!--<div class="b_leftsection">-->
                    <!--<div class="single_chunk b_number">-->
                        <!--<div class="chunk_title title">Block#: </div>-->
                        <!--<div class="chunk_content">0</div>-->

                    <!--</div>-->
                    <!--<div class="single_chunk b_ts">-->
                        <!--<div class="chunk_title title">TimeStamp: </div>-->
                        <!--<div class="chunk_content">12.59</div>-->
                    <!--</div>-->

                    <!--<div class="single_chunk b_ph">-->
                        <!--<div class="chunk_title title">PrHash: </div>-->
                        <!--<div class="chunk_content">ad1e12</div>-->
                    <!--</div>-->

                <!--</div>-->
                <!--<div class="b_midsection">-->
                    <!--<div class="single_chunk b_nonce">-->
                        <!--<div class="chunk_title title">Nonce: </div>-->
                        <!--<div class="chunk_content">45</div>-->
                    <!--</div>-->
                    <!--<div class="single_chunk b_fb">-->
                        <!--<div class="chunk_title title">FoundBy: </div>-->
                        <!--<div class="chunk_content">John</div>-->

                    <!--</div>-->
                    <!--<div class="single_chunk b_col">-->
                        <!--<div class="chunk_title title">Colour: </div>-->
                        <!--<div class="chunk_content">#45581</div>-->

                    <!--</div>-->
                <!--</div>-->
                <!--<div class="b_rightsection">-->
                    <!--<div class="b_messagesbox">-->
                        <!--<div class="b_message">12:58 - John - Hello There!!</div>-->
                        <!--<div class="b_message">12:58 - John - Hello There!!</div>-->
                        <!--<div class="b_message">12:58 - John - Hello There!!</div>-->
                        <!--<div class="b_message">12:58 - John - Hello There!!</div>-->
                    <!--</div>-->
                <!--</div>-->
            <!--</div>-->


        </div>
    </section>

    <!--Clients Header-->
    <section id="content3">
        <div class = "tab_contents">
            <div class="tab_header">
                <div class="header_box">
                    <button class="c_add" id="c_btn_add" onclick="Bot()">+</button>
                </div>
            </div>

            <ul id="tabs_client_list" class="tab_items_list">

                <!--<li id="c2" class="item_portion">-->
                    <!--<div class="c_leftsection">-->
                        <!--<div class="c_block"></div>-->
                    <!--</div>-->
                    <!--<div class="c_midsection">First Entry - Needs Removing</div>-->
                    <!--<div class="c_rightsection">-->
                        <!--<label class="switch">-->
                            <!--<input type="checkbox" checked>-->
                            <!--<span class="slider round"></span>-->
                        <!--</label>-->
                        <!--<button class="c_remove" id="c_btn_remove" onclick="removeBot()">-</button>-->
                    <!--</div>-->
                <!--</li>-->

            </ul>
        </div>
    </section>

    <!--Mining Header-->
    <section id="content4">
        <div class = "tab_contents">
            <div class="tab_header">
                <div class="header_box">
                    <label class="switch">
                        <input type="checkbox" checked>
                        <span class="slider round"></span>
                    </label>

                </div>
            </div>

            <div class="miner_statlayer1">
                <div class="miner_statlayer_leftsection title">Current Block</div>
            </div>
            <div class="miner_statlayer2">
                <div class="miner_statlayer_leftsection">

                    <div class="miner_statlayer1_leftsection_title">
                        <div class="mi_block" style="background: rgb(202, 135, 197)"></div>
                        Block#: </div>
                    <div id="m_s" class="miner_statlayer1_leftsection_content">1</div>
                </div>
            </div>

                <div class="miner_statlayer2">
                <div class="miner_statlayer_leftsection">
                    <div class="miner_statlayer_leftsection_title title">Nonce</div>
                    <div id="m_nonce" class="miner_statlayer_leftsection_content">45</div>
                </div>
                <div class="miner_statlayer_midsection">
                    <div class="miner_statlayer_midsection_title title">Package</div>
                    <div id="m_package" class="miner_statlayer_midsection_content">45</div>

                </div>

            </div>
            <div class="miner_statlayer2">
                <div class="miner_statlayer_leftsection">
                    <div class="miner_statlayer_leftsection_title title">Hit</div>
                    <div id="m_hit" class="miner_statlayer_leftsection_content">Yes</div>

                </div>
                <div class="miner_statlayer_midsection">
                    <div class="miner_statlayer_midsection_title title">Difficulty</div>
                    <div id="m_difficulty" class="miner_statlayer_midsection_content">45</div>

                </div>
            </div>

            <div id="attempts_titles" class="miner_attempt">
                <div class="a_col_block title">Block</div>
                <div class="a_col_hit title">Hit</div>
                <div class="a_col_nonce title">Nonce</div>
                <div class="a_col_package title">Package</div>
                <div class="a_col_messages title">Messages</div>
            </div>

            <div id="a1" class="miner_attempt">
                <div class="a_col_block">a</div>
                <div class="a_col_hit">a</div>
                <div class="a_col_nonce">a</div>
                <div class="a_col_package">a</div>
                <div class="a_col_messages">a</div>
            </div>
            <div id="a2" class="miner_attempt">
                <div class="a_col_block">a</div>
                <div class="a_col_hit">a</div>
                <div class="a_col_nonce">a</div>
                <div class="a_col_package">a</div>
                <div class="a_col_messages">a</div>
            </div>
            <div id="a3" class="miner_attempt">
                <div class="a_col_block">a</div>
                <div class="a_col_hit">a</div>
                <div class="a_col_nonce">a</div>
                <div class="a_col_package">a</div>
                <div class="a_col_messages">a</div>
            </div>
        </div>
    </section>

</div>

<p id="load">Firebase SDK Loading&hellip;</p>

<div id="messageSnackbar" class="messageSnackbar">Text updated across all devices viewing this page</div>

<script>



    var db = firebase.firestore();

    retrieveUsers();
    retrieveBlocks();
    retrieveMessages();

    // var msgInput = document.getElementById("messageText");
    // msgInput.addEventListener("keyup", function(event) {
    //     event.preventDefault();
    //     if (event.keyCode === 13) {
    //         newMessage();
    //     }
    // });

    function retrieveUsers() {
        users = [];
        db.collection("users").get().then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
                let user = new User();
                let dbUser = doc.data();
                user.userID = doc.id;
                user.name = dbUser.name;
                user.coX = dbUser.coX;
                user.coY = dbUser.coY;
                user.blockColour = dbUser.blockColour;
                user.bot = dbUser.bot;
                user.mining = dbUser.mining;

                addUser(user);
            }), refreshNodeList();
        });
    }
    function retrieveBlocks() {
        allBlocks = [];
        db.collection("blocks").get().then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
                let block = new Block();
                let dbBlock = doc.data();
                block.blockID = doc.id;
                block.blockNo = dbBlock.blockNo;
                block.hash = dbBlock.hash;
                block.time = dbBlock.time;
                block.findingUser = dbBlock.findingUser;
                block.messages = dbBlock.messages;
                block.messageHash = dbBlock.messageHash;
                block.diff = dbBlock.diff;

                addBlock(block);
            }), refreshBlockList();
        });
    }


    function retrieveMessages() {
        messages = [];
        db.collection("messages").orderBy('Time').get().then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
                let message = new Message();
                let dbMessage = doc.data();
                message.messageID = doc.id;
                message.Content = dbMessage.Content;
                message.Concensus = dbMessage.Concensus;
                message.UserID = dbMessage.UserID;
                message.Time = dbMessage.Time;

                addMessage(message);
            }), refreshMessages();
        });
    }

    db.collection("messages")
        .onSnapshot(function (snapshot) {
            retrieveMessages()
        },function (error) {
            console(error);
        });

    db.collection("blocks")
        .onSnapshot(function (snapshot) {
            retrieveBlocks()
        },function (error) {
            console(error);
        });

    db.collection("users")
        .onSnapshot(function (snapshot) {
            retrieveUsers()
        },function (error) {
            console(error);
        });

    //New message
    function newMessage() {
        var message = new Message();
        message.UserID = localUser.userID;
        message.Content = document.getElementById('messageText').value;

        db.collection("messages").doc().set({
            Content: message.Content,
            Concensus: message.Concensus,
            UserID: message.UserID,
            Time: message.Time
        })
            .then(function() {
                addMessage(message);
                refreshMessages();
                console.log("Document successfully written!");
            })
            .catch(function(error) {
                console.error("Error writing document: ", error);
            });
        document.getElementById('messageText').value = "";

        // var lastMessage = db.collection("messages").orderBy('Time', 'desc').limit(1);

        snackbar(message.UserID);
    }

    function snackbar(text){
        var snackbar = document.getElementById("messageSnackbar");
        snackbar.innerText = text;
        snackbar.className = "show";
        setTimeout(function(){ snackbar.className = snackbar.className.replace("show", ""); }, 3000);
    }

</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // // The Firebase SDK is initialized and available here!
        //
        // firebase.auth().onAuthStateChanged(user => { });
        // firebase.database().ref('/path/to/ref').on('value', snapshot => { });
        // firebase.messaging().requestPermission().then(() => { });
        // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
        //
        // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

        try {
            let app = firebase.app();
            let features = ['auth', 'database', 'messaging', 'storage', 'firestore'].filter(feature => typeof app[feature] === 'function');
            document.getElementById('load').innerHTML = `Firebase SDK loaded with ${features.join(', ')}`;
        } catch (e) {
            console.error(e);
            document.getElementById('load').innerHTML = '!!  FIREBASE BROKEN  !!';
        }
    });
</script>

</body>
</html>